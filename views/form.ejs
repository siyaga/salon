<%- include('partials/header') %>

<div class="row justify-content-center">
  <div class="col-md-6 col-lg-5">
    <div class="card shadow-lg border-0 rounded-4">
      <div class="card-body p-4 p-md-5">
        
        <div class="text-center mb-4">
          <img src="/img/logo.png" alt="<%= appName %> Logo" style="height: 50px; margin-bottom: 10px;">
          <h3 class="fw-bold mt-2">Reservasi <%= appName %></h3>
          <p class="text-muted">Booking Antrian Anda Sekarang</p>
        </div>
        
        <form action="/submit" method="POST" id="form-antrian" novalidate>
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">

          <div id="step-1-cabang">
            <div class="mb-3">
              <label for="cabang" class="form-label fw-bold">1. Pilih Cabang</label>
              <select class="form-select" id="cabang" name="cabang" required>
                <option value="" disabled selected>-- Tentukan Lokasi Cabang --</option>
                <% if (branches && branches.length > 0) { %>
                  <% branches.forEach(branch => { %>
                    <option value="<%= branch %>"><%= branch %></option>
                  <% }) %>
                <% } %>
              </select>
              <div class="invalid-feedback">Anda harus memilih cabang.</div>
            </div>
          </div> <div id="step-2-status" style="display: none;">
            <hr class="my-4">
            <div class="mb-3">
              <label class="form-label fw-bold">2. Status Anda</label>
              <div class="d-grid gap-2">
                <input type="radio" class="btn-check" name="status_member" id="status-new" value="new" autocomplete="off" required>
                <label class="btn btn-outline-secondary" for="status-new"><i class="bi bi-person-plus-fill me-2"></i>Saya Pelanggan Baru</label>

                <input type="radio" class="btn-check" name="status_member" id="status-member" value="member" autocomplete="off" required>
                <label class="btn btn-outline-secondary" for="status-member"><i class="bi bi-person-check-fill me-2"></i>Saya Member Lama</label>
              </div>
            </div>
          </div> <div id="step-3-data-diri" style="display: none;">
            <hr class="my-4">
            <h5 id="data-diri-title" class="fw-bold text-primary"></h5>
            
            <div class="mb-3">
              <label for="no_wa" class="form-label">Nomor WhatsApp</label>
              <input type="tel" class="form-control" id="no_wa" name="no_wa" placeholder="0812..." required pattern="^(\+62|62|0)8[0-9]{8,12}$">
              <div class="invalid-feedback">Format nomor WA salah (cth: 0812...).</div>
            </div>
            
            <div class="mb-3">
              <label for="nama" class="form-label">Nama Anda</label>
              <input type="text" class="form-control" id="nama" name="nama" required>
              <div class="invalid-feedback">Nama wajib diisi.</div>
            </div>
            
            <div id="new-member-fields" style="display: none;">
              <div class="mb-3">
                <label for="tgl_lahir" class="form-label">Tanggal Lahir</label>
                <input type="date" class="form-control" id="tgl_lahir" name="tgl_lahir" required>
                <div class="form-text small text-muted">(untuk promo ulang tahun)</div>
                <div class="invalid-feedback">Tanggal lahir wajib diisi.</div>
              </div>
              <div class="mb-3">
                <label for="alamat" class="form-label">Alamat Singkat</label>
                <textarea class="form-control" id="alamat" name="alamat" rows="2" placeholder="cth: Jl. Merdeka No. 10" required></textarea>
                <div class="invalid-feedback">Alamat wajib diisi.</div>
              </div>
            </div>
          </div> <div id="step-4-paket-detail" style="display: none;">
            <hr class="my-4">
            <h5 class="fw-bold text-primary">Detail Reservasi</h5>

            <div class="mb-3" id="paket-group">
              <label class="form-label fw-bold">Pilih Paket (Bisa lebih dari satu)</label>
              <% if (groupedPackages && groupedPackages.length > 0) { %>
                <% groupedPackages.forEach((group, groupIndex) => { %>
                  <h6 class="fw-bold mt-3 mb-2 ps-1 text-primary"><%= group.kategori %></h6>
                  <% group.paket.forEach((paket, paketIndex) => { %>
                    <div class="form-check ps-4 mb-2">
                      <input class="form-check-input paket-checkbox" type="checkbox" 
                             name="paket" value="<%= paket.nama %>" id="paket-<%= groupIndex %>-<%= paketIndex %>">
                      <label class="form-check-label" for="paket-<%= groupIndex %>-<%= paketIndex %>">
                        <strong class="d-block"><%= paket.nama %></strong>
                        <span class="text-muted small"><i class="bi bi-clock"></i> <%= paket.durasi %></span>
                        <span class="text-muted small d-block"><%= paket.deskripsi %></span>
                      </label>
                    </div>
                  <% }) %>
                <% }) %>
              <% } else { %>
                <p class="text-muted small">Gagal memuat paket.</p>
              <% } %>
              <input type="text" id="paket-validation-helper" required style="width: 0; height: 0; padding: 0; border: none; opacity: 0; position: absolute;">
              <div class="invalid-feedback">Paket wajib dipilih (minimal satu).</div>
            </div>
            
            <div class="mb-3">
              <label for="jam_datang" class="form-label">Jam Reservasi</label>
              <input type="time" class="form-control" id="jam_datang" name="jam_datang" required>
              <div class="invalid-feedback">Jam reservasi wajib diisi.</div>
            </div>
            
            <div class="mb-3">
              <label for="note" class="form-label">Note (Opsional)</label>
              <textarea class="form-control" id="note" name="note" rows="2" placeholder="Kebutuhan khusus, alergi, request stylist, dll."></textarea>
            </div>
            
            <div class="d-grid mt-4">
              <button type="button" class="btn btn-primary btn-lg" id="btn-show-modal">
                <i class="bi bi-ticket-perforated me-2"></i>Ambil Nomor Antrian
              </button>
            </div>
          </div> </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="konfirmasiModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-4">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="modalLabel">Konfirmasi Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Apakah data di bawah ini sudah benar?</p>
        <div class="alert alert-secondary">
          <strong><i class="bi bi-shop-window me-2"></i>Cabang:</strong> <span id="konfirmasi-cabang" class="float-end fw-bold"></span><br>
          <strong><i class="bi bi-person-fill me-2"></i>Nama:</strong> <span id="konfirmasi-nama" class="float-end"></span><br>
          <strong><i class="bi bi-whatsapp me-2"></i>No. WA:</strong> <span id="konfirmasi-wa" class="float-end"></span><br>
          <strong><i class="bi bi-house-fill me-2"></i>Alamat:</strong> <span id="konfirmasi-alamat" class="float-end"></span><br>
          <strong><i class="bi bi-calendar-heart me-2"></i>Tgl. Lahir:</strong> <span id="konfirmasi-tgl-lahir" class="float-end"></span><br>
          <strong><i class="bi bi-clock-fill me-2"></i>Jam:</strong> <span id="konfirmasi-jam-datang" class="float-end"></span><br>
          <strong><i class="bi bi-chat-left-text me-2"></i>Note:</strong> <span id="konfirmasi-note" class="float-end"></span><br>
          <strong><i class="bi bi-scissors me-2"></i>Paket:</strong>
          <div id="konfirmasi-paket" class="text-end" style="font-weight: 500;"></div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" id="btn-submit-form">Ya, Yakin!</button>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // --- Referensi Elemen ---
    const form = document.getElementById('form-antrian');
    const step2Status = document.getElementById('step-2-status');
    const step3DataDiri = document.getElementById('step-3-data-diri');
    const step4PaketDetail = document.getElementById('step-4-paket-detail');
    
    const statusTitle = document.getElementById('data-diri-title');
    const newMemberFields = document.getElementById('new-member-fields');
    const tglLahirInput = document.getElementById('tgl_lahir');
    const alamatInput = document.getElementById('alamat');
    
    const radioNew = document.getElementById('status-new');
    const radioMember = document.getElementById('status-member');
    const cabangSelect = document.getElementById('cabang');
    
    // --- Helper Validasi Paket (untuk modal) ---
    const paketValidationHelper = document.getElementById('paket-validation-helper');
    function updatePaketValidation() {
      const checkedCount = document.querySelectorAll('.paket-checkbox:checked').length;
      paketValidationHelper.value = checkedCount > 0 ? "valid" : "";
    }
    // Tambahkan listener ke semua checkbox paket
    document.querySelectorAll('.paket-checkbox').forEach(cb => {
      cb.addEventListener('change', updatePaketValidation);
    });
    updatePaketValidation(); // Panggil saat load

    
    // --- 1. Logika Tampilkan Step 2 (Status) ---
    // Tampilkan Step 2 jika Step 1 (Cabang) sudah valid
    cabangSelect.addEventListener('change', () => {
      if (cabangSelect.value !== '') {
        step2Status.style.display = 'block';
      } else {
        // Sembunyikan semua step di bawahnya jika cabang diubah kembali
        step2Status.style.display = 'none';
        step3DataDiri.style.display = 'none';
        step4PaketDetail.style.display = 'none';
      }
    });

    // --- 2. Logika Tampilkan Step 3 & 4 (Data Diri & Paket) ---
    function showRemainingForm() {
      step3DataDiri.style.display = 'block';
      step4PaketDetail.style.display = 'block';
    }

    radioNew.addEventListener('change', () => {
      showRemainingForm();
      newMemberFields.style.display = 'block';
      statusTitle.innerText = "3. Lengkapi Data Diri (Pelanggan Baru)";
      
      // WAJIB diisi
      tglLahirInput.required = true;
      alamatInput.required = true;
    });
    
    radioMember.addEventListener('change', () => {
      showRemainingForm();
      newMemberFields.style.display = 'none'; // Sembunyikan field Tgl Lahir & Alamat
      statusTitle.innerText = "3. Lengkapi Data Diri (Member)";
      
      // TIDAK WAJIB diisi (karena akan dikirim kosong)
      tglLahirInput.required = false;
      alamatInput.required = false;
    });

    // --- 3. Logika Validasi Form (Sama seperti sebelumnya) ---
    const btnShowModal = document.getElementById('btn-show-modal');
    const modalElement = document.getElementById('konfirmasiModal');
    const modal = new bootstrap.Modal(modalElement);
    const btnSubmitForm = document.getElementById('btn-submit-form');

    btnShowModal.addEventListener('click', function(event) {
      event.preventDefault(); 
      form.classList.remove('was-validated');
      
      // Update validasi paket sekali lagi sebelum cek
      updatePaketValidation();

      if (form.checkValidity()) {
        document.getElementById('konfirmasi-cabang').textContent = cabangSelect.options[cabangSelect.selectedIndex].text;
        document.getElementById('konfirmasi-nama').textContent = document.getElementById('nama').value;
        document.getElementById('konfirmasi-wa').textContent = document.getElementById('no_wa').value;
        document.getElementById('konfirmasi-alamat').textContent = alamatInput.value || '-'; // Tampilkan '-' jika kosong (untuk member)
        document.getElementById('konfirmasi-tgl-lahir').textContent = tglLahirInput.value || '-'; // Tampilkan '-' jika kosong (untuk member)
        document.getElementById('konfirmasi-jam-datang').textContent = document.getElementById('jam_datang').value;
        document.getElementById('konfirmasi-note').textContent = document.getElementById('note').value || '-';
        
        let paketListHTML = '';
        document.querySelectorAll('input[name="paket"]:checked').forEach(cb => {
          paketListHTML += cb.labels[0].querySelector('strong').textContent.trim() + '<br>'; 
        });
        document.getElementById('konfirmasi-paket').innerHTML = paketListHTML;
        
        modal.show();
      } else {
        form.classList.add('was-validated');
      }
    });

    btnSubmitForm.addEventListener('click', function() {
      form.submit();
    });
  });
</script>