<%- include('partials/header') %>

<div class="row justify-content-center">
  <div class="col-md-6 col-lg-5">
    <div class="card shadow-lg border-0 rounded-4">
      <div class="card-body p-4 p-md-5">
        
        <div class="text-center mb-4">
          <img src="/img/logo.png" alt="<%= appName %> Logo" style="height: 50px; margin-bottom: 10px;">
          <h3 class="fw-bold mt-2">Reservasi <%= appName %></h3>
          <p class="text-muted">Booking Antrian Anda Sekarang</p>
        </div>
        
        <form action="/submit" method="POST" id="form-antrian" novalidate>
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">

          <div class="mb-3">
            <label for="cabang" class="form-label">Pilih Cabang</label>
            <select class="form-select" id="cabang" name="cabang" required>
              <option value="" disabled selected>-- Tentukan Lokasi Cabang --</option>
              <% if (branches && branches.length > 0) { %>
                <% branches.forEach(branch => { %>
                  <option value="<%= branch %>"><%= branch %></option>
                <% }) %>
              <% } %>
            </select>
            <div class="invalid-feedback">Anda harus memilih cabang.</div>
          </div>
          
          <div class="mb-3">
            <label for="no_wa" class="form-label fw-bold">Nomor WhatsApp</label>
            <div class="input-group has-validation">
              <input type="tel" class="form-control" id="no_wa" name="no_wa" 
                     placeholder="0812..." required pattern="^(\+62|62|0)8[0-9]{8,12}$">
              <div class="invalid-feedback">Format nomor WA salah.</div>
            </div>
            <div id="user-status" class="form-text mt-2">
              </div>
          </div>

          <div id="data-diri-group" style="display: none;">
            <hr>
            <p id="data-diri-title" class="fw-bold text-primary"></p>
            
            <div class="mb-3">
              <label for="nama" class="form-label">Nama Anda</label>
              <input type="text" class="form-control" id="nama" name="nama" required>
              <div class="invalid-feedback">Nama wajib diisi.</div>
            </div>

            <div class="mb-3" id="verifikasi-tgl-lahir-group" style="display: none;">
              <label for="verifikasi_tgl_lahir" class="form-label">Verifikasi Tanggal Lahir</label>
              <input type="date" class="form-control" id="verifikasi_tgl_lahir" name="verifikasi_tgl_lahir">
              <div class="form-text small text-danger" id="verifikasi-error-msg"></div>
            </div>

            <div class="mb-3">
              <label for="tgl_lahir" class="form-label">Tanggal Lahir</label>
              <input type="date" class="form-control" id="tgl_lahir" name="tgl_lahir" required>
              <div class="form-text small text-muted" style="margin-top: 0.25rem;">(untuk promo ulang tahun)</div>
              <div class="invalid-feedback">Tanggal lahir wajib diisi.</div>
            </div>

            <div class="mb-3">
              <label for="alamat" class="form-label">Alamat Singkat</label>
              <textarea class="form-control" id="alamat" name="alamat" rows="2" placeholder="cth: Jl. Merdeka No. 10" required></textarea>
              <div class="invalid-feedback">Alamat wajib diisi.</div>
            </div>
            <hr>
          </div>
          <div class="row">
            <div class="col-md-12 mb-3"> <label for="jam_datang" class="form-label">Jam Reservasi</label>
              <input type="time" class="form-control" id="jam_datang" name="jam_datang" required>
              <div class="invalid-feedback">Jam reservasi wajib diisi.</div>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="note" class="form-label">Note (Opsional)</label>
            <textarea class="form-control" id="note" name="note" rows="2" placeholder="Kebutuhan khusus, alergi, request stylist, dll."></textarea>
          </div>
          
          <div class="mb-3" id="paket-group">
            <label class="form-label fw-bold">Pilih Paket</label>
            <% if (groupedPackages && groupedPackages.length > 0) { %>
              <% groupedPackages.forEach((group, groupIndex) => { %>
                <h6 class="fw-bold mt-3 mb-2 ps-1 text-primary"><%= group.kategori %></h6>
                <% group.paket.forEach((paket, paketIndex) => { %>
                  <div class="form-check ps-4 mb-2">
                    <input class="form-check-input" type="checkbox" 
                           name="paket" value="<%= paket.nama %>" id="paket-<%= groupIndex %>-<%= paketIndex %>">
                    <label class="form-check-label" for="paket-<%= groupIndex %>-<%= paketIndex %>">
                      <strong class="d-block"><%= paket.nama %></strong>
                      <span class="text-muted small"><i class="bi bi-clock"></i> <%= paket.durasi %></span>
                      <span class="text-muted small d-block" style="font-size: 0.8em;"><%= paket.deskripsi %></span>
                    </label>
                  </div>
                <% }) %>
              <% }) %>
            <% } else { %>
              <p class="text-muted small">Gagal memuat paket.</p>
            <% } %>
            <input type="text" id="paket-validation-helper" required style="width: 0; height: 0; padding: 0; border: none; opacity: 0; position: absolute;">
            <div class="invalid-feedback">Paket wajib dipilih (minimal satu).</div>
          </div>

          <div class="d-grid mt-4">
            <button type="button" class="btn btn-primary btn-lg" id="btn-show-modal">
              <i class="bi bi-ticket-perforated me-2"></i>Ambil Nomor Antrian
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="konfirmasiModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-4">
      <div class="modal-header border-0">
        <h5 class="modal-title" id="modalLabel">Konfirmasi Data</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Apakah data di bawah ini sudah benar?</p>
        <div class="alert alert-secondary">
          <strong><i class="bi bi-shop-window me-2"></i>Cabang:</strong> <span id="konfirmasi-cabang" class="float-end fw-bold"></span><br>
          <strong><i class="bi bi-person-fill me-2"></i>Nama:</strong> <span id="konfirmasi-nama" class="float-end"></span><br>
          <strong><i class="bi bi-whatsapp me-2"></i>No. WA:</strong> <span id="konfirmasi-wa" class="float-end"></span><br>
          <strong><i class="bi bi-house-fill me-2"></i>Alamat:</strong> <span id="konfirmasi-alamat" class="float-end"></span><br>
          <strong><i class="bi bi-calendar-heart me-2"></i>Tgl. Lahir:</strong> <span id="konfirmasi-tgl-lahir" class="float-end"></span><br>
          <strong><i class="bi bi-clock-fill me-2"></i>Jam:</strong> <span id="konfirmasi-jam-datang" class="float-end"></span><br>
          <strong><i class="bi bi-chat-left-text me-2"></i>Note:</strong> <span id="konfirmasi-note" class="float-end"></span><br>
          <strong><i class="bi bi-scissors me-2"></i>Paket:</strong>
          <div id="konfirmasi-paket" class="text-end" style="font-weight: 500;"></div>
        </div>
      </div>
      <div class="modal-footer border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="button" class="btn btn-primary" id="btn-submit-form">Ya, Yakin!</button>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // --- Element References ---
    const form = document.getElementById('form-antrian');
    const waInput = document.getElementById('no_wa');
    const namaInput = document.getElementById('nama');
    const tglInput = document.getElementById('tgl_lahir');
    const alamatInput = document.getElementById('alamat');
    const statusDiv = document.getElementById('user-status');
    const dataDiriGroup = document.getElementById('data-diri-group');
    const dataDiriTitle = document.getElementById('data-diri-title');
    const verifikasiGroup = document.getElementById('verifikasi-tgl-lahir-group');
    const verifikasiInput = document.getElementById('verifikasi_tgl_lahir');
    const verifikasiError = document.getElementById('verifikasi-error-msg');
    let typingTimer;

    // --- Helper Function ---
    function showDataDiri(title, isUserLama = false) {
      dataDiriGroup.style.display = 'block';
      dataDiriTitle.innerText = title;
      
      // If EXISTING user, hide the real birthdate field
      // and show the verification field
      if (isUserLama) {
        verifikasiGroup.style.display = 'block';
        tglInput.closest('.mb-3').style.display = 'none'; // Hide the original birthdate field
        
        // Lock fields until verified
        namaInput.readOnly = true;
        tglInput.readOnly = true;
        alamatInput.readOnly = true;
      } else {
        // If NEW user, show all fields
        verifikasiGroup.style.display = 'none';
        tglInput.closest('.mb-3').style.display = 'block';
        
        // Ensure fields are not locked
        namaInput.readOnly = false;
        tglInput.readOnly = false;
        alamatInput.readOnly = false;
      }
    }

    // --- 1. WA CHECK LOGIC (on keyup) ---
    waInput.addEventListener('keyup', () => {
      clearTimeout(typingTimer);
      statusDiv.innerHTML = '<span class="text-muted fst-italic">Checking...</span>';
      typingTimer = setTimeout(checkUserByPhone, 1000); // Wait 1 sec after typing
    });

    async function checkUserByPhone() {
      const phone = waInput.value;
      if (phone.length < 10) {
        statusDiv.innerHTML = '';
        dataDiriGroup.style.display = 'none';
        return;
      }

      try {
        const res = await fetch(`/api/check-user?phone=${phone}`);
        const data = await res.json();

        if (data.found) {
          // MEMBER FOUND
          statusDiv.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Member Found</span>';
          showDataDiri('Please verify your identity', true);
        } else {
          // NEW MEMBER
          statusDiv.innerHTML = '<span class="badge bg-secondary">New Customer</span>';
          showDataDiri('Please complete your data', false);
        }
      } catch (err) {
        statusDiv.innerHTML = '';
      }
    }

    // --- 2. BIRTHDATE VERIFICATION LOGIC (on change) ---
    verifikasiInput.addEventListener('change', async () => {
      const phone = waInput.value;
      const tgl_lahir = verifikasiInput.value;
      verifikasiError.innerText = '';
      
      if (!phone || !tgl_lahir) return;

      try {
        const res = await fetch(`/api/get-user-data?phone=${phone}&tgl_lahir=${tgl_lahir}`);
        const data = await res.json();

        if (data.success) {
          // VERIFICATION SUCCESS
          verifikasiError.innerText = '';
          verifikasiGroup.style.display = 'none'; // Hide verification field
          tglInput.closest('.mb-3').style.display = 'block'; // Show original birthdate field
          
          // Auto-fill and lock
          namaInput.value = data.nama;
          tglInput.value = tgl_lahir; // Use the value from the verification input
          alamatInput.value = data.alamat;
          
          namaInput.readOnly = true;
          tglInput.readOnly = true;
          alamatInput.readOnly = true;

          // Add visual cue
          namaInput.classList.add('is-valid');
          tglInput.classList.add('is-valid');
          alamatInput.classList.add('is-valid');
        } else {
          // VERIFICATION FAILED
          verifikasiError.innerText = 'Incorrect birth date. Please try again.';
          namaInput.classList.remove('is-valid');
          tglInput.classList.remove('is-valid');
          alamatInput.classList.remove('is-valid');
        }
      } catch (err) {
        verifikasiError.innerText = 'Failed to verify data.';
      }
    });

    // --- 3. FORM VALIDATION LOGIC (SAME AS BEFORE) ---
    const btnShowModal = document.getElementById('btn-show-modal');
    const modalElement = document.getElementById('konfirmasiModal');
    const modal = new bootstrap.Modal(modalElement);
    const btnSubmitForm = document.getElementById('btn-submit-form');
    const paketCheckboxes = document.querySelectorAll('input[name="paket"]');
    const paketValidationHelper = document.getElementById('paket-validation-helper');

    function updatePaketValidation() {
      const checkedCheckboxes = document.querySelectorAll('input[name="paket"]:checked');
      paketValidationHelper.value = checkedCheckboxes.length > 0 ? "valid" : "";
    }
    paketCheckboxes.forEach(checkbox => checkbox.addEventListener('change', updatePaketValidation));
    updatePaketValidation();

    btnShowModal.addEventListener('click', function(event) {
      event.preventDefault(); 
      if (form.checkValidity()) {
        // Get data for modal
        const cabangSelect = document.getElementById('cabang');
        document.getElementById('konfirmasi-cabang').textContent = cabangSelect.options[cabangSelect.selectedIndex].text;
        document.getElementById('konfirmasi-nama').textContent = namaInput.value;
        document.getElementById('konfirmasi-wa').textContent = waInput.value;
        document.getElementById('konfirmasi-alamat').textContent = alamatInput.value;
        document.getElementById('konfirmasi-tgl-lahir').textContent = tglInput.value;
        document.getElementById('konfirmasi-jam-datang').textContent = document.getElementById('jam_datang').value;
        document.getElementById('konfirmasi-note').textContent = document.getElementById('note').value || '-';
        
        let paketListHTML = '';
        document.querySelectorAll('input[name="paket"]:checked').forEach(cb => {
          paketListHTML += cb.labels[0].querySelector('strong').textContent.trim() + '<br>'; 
        });
        document.getElementById('konfirmasi-paket').innerHTML = paketListHTML;
        
        modal.show();
      } else {
        form.classList.add('was-validated');
      }
    });

    btnSubmitForm.addEventListener('click', function() {
      form.submit();
    });
  });
</script>